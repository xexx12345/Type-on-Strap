---
layout: post
title: "Vigilant Asset Allocation Signals"
tags: [code]
---

From Dr. Wouter Keller and JW Keuning [VAA Paper](https://papers.ssrn.com/sol3/papers.cfm?abstract_id=3002624) is a dual-momentum based investment strategy with a vigorous crash protection and a fast momentum filter. Dual momentum combines absolute (trendfollowing) and relative (strength) momentum.


### VAA Implementation

Using the Azure Notebook:

```python
!pip install ffn
!pip install alpha_vantage

import pandas as pd
import numpy as np
import pickle
from pandas import ExcelWriter
import ffn
%matplotlib inline

def save_xls(list_dfs, xls_path,sheet_names):
    writer = ExcelWriter(xls_path)
    for n, df in enumerate(list_dfs):
        df.to_excel(writer, sheet_names[n])
    writer.save()
    return

#pull in data from AlphaVantage
from alpha_vantage.timeseries import TimeSeries
ts = TimeSeries(key='YOURKEYHERE',output_format='pandas')

```
Summary of Strategy Rules from Allocate Smartly:

* The model includes both an offensive and defensive universe:
* Offensive: US equities (represented by SPY), international equities (EFA), emerging market equities (EEM) and US aggregate bonds (AGG). More on the seemingly odd inclusion of AGG as an offensive asset in a moment.
* Defensive: US corporate bonds (LQD), US intermediate-term Treasuries (IEF) and US short-term Treasuries (SHY).
* For all assets, at the close on the last trading day of the month, calculate a “momentum score” based on month-end data as follows:
(12 * (p0 / p1 – 1)) + (4 * (p0 / p3 – 1)) + (2 * (p0 / p6 – 1)) + (p0 / p12 – 1)
* Where p0 = the asset price at today’s close, p1 = the asset price at the close of the previous month, etc.
Note how this approach overweights more recent months. Doing the math, the most recent 1-month change (p0/p1 – 1) determines 40% of the momentum score, while the most distant month (p11/p12 – 1) determines just ~2%.

* If all four of the offensive assets exhibit positive momentum scores, select the offensive asset with the highest score and allocate 100% of the portfolio to that asset at the close. Note the use of both absolute and relative momentum here, an idea popularized by Gary Antonacci as “Dual Momentum”. Why is that important? Historically, absolute momentum has done well minimizing losses, while relative momentum has helped in generating outsized returns.
* If any of the four offensive assets exhibit negative momentum scores, select the defensive asset (LQD, IEF or SHY) with the highest score (regardless of whether the score is > 0) and allocate 100% of the portfolio to that asset at the close. As we do throughout this site, trades in SHY are assumed to be placed in cash, as it’s more relevant to today’s market given SHY’s low yields coupled with the impact of transaction costs and how frequently this strategy trades.
* Hold the position until the final trading day of the following month.

### Creating the Momentum Indicator

```python
VAA = ['AGG', 'EFA', 'EEM','LQD','IEF','SHY']
Maindf = historical_data("SPY")
Maindf.index = pd.to_datetime(Maindf.timestamp) #set the index as the timestamp
#Maindf.index = pd.to_datetime(Maindf.index) #make the index datetime
Maindf = Maindf[['timestamp','close']]
Maindf.columns = ["timestamp","SPY"]

for ticker in VAA:
    temp_df = historical_data(ticker)
    temp_df.index = pd.to_datetime(temp_df.timestamp) #set the index as the timestamp
    temp_df = temp_df[['close']]
    temp_df.columns = [ticker]
    Maindf = Maindf.join(temp_df, how = "left")

Maindf.dropna(inplace = True)
Maindf = Maindf.sort_index()

Maindf['Year'] = Maindf.index.year
Maindf['Month'] = Maindf.index.month
Maindf['Day'] = Maindf.index.day
Maindf['Month Change'] = Maindf['Month'] - Maindf['Month'].shift(-1) #shift -1 moves row up

Maindf_EOM = Maindf[Maindf['Month Change'] != 0]
Maindf_EOM = Maindf_EOM[['SPY','AGG','EFA','EEM','LQD','IEF','SHY']]

Maindf_EOM_VAA = Maindf_EOM.pct_change(12) + 2 * Maindf_EOM.pct_change(6) + 4 * Maindf_EOM.pct_change(3) + 12 * Maindf_EOM.pct_change(1)

Maindf_EOM_VAA['Indicator'] = np.where(Maindf_EOM_VAA[['SPY','AGG','EFA','EEM']].min(axis = 1) > 0, Maindf_EOM_VAA[['SPY','AGG','EFA','EEM']].idxmax(axis = 1), Maindf_EOM_VAA[['LQD','IEF','SHY']].idxmax(axis = 1))
```


SPY	AGG	EFA	EEM	LQD	IEF	SHY	Indicator
timestamp								
2017-10-31	0.821054	-0.032121	0.749895	1.176776	0.029542	-0.110077	-0.049771	LQD
2017-11-30	1.047712	-0.096997	0.631815	0.603100	-0.037711	-0.171872	-0.086394	LQD
2017-12-29	0.733749	0.026478	0.515784	1.094493	0.154199	-0.062788	-0.077804	EEM
2018-01-31	1.584975	-0.215090	1.289112	2.103068	-0.176415	-0.448897	-0.101025	SHY
2018-02-28	0.007909	-0.317373	-0.305730	-0.134892	-0.506558	-0.409951	-0.095022	SHY
2018-03-29	-0.219928	-0.076286	0.017090	0.544013	-0.172176	-0.055630	-0.029012	SHY
2018-04-30	-0.016480	-0.310711	0.155278	-0.461291	-0.512819	-0.365218	-0.098303	SHY
2018-05-31	0.448191	-0.037642	-0.246528	-0.417471	-0.151303	0.003708	0.000828	IEF
2018-06-29	0.293683	-0.134658	-0.643602	-1.143932	-0.355978	-0.122788	-0.046741	SHY
2018-07-23	0.755957	-0.126080	-0.093123	-0.470090	-0.132018	-0.168443	-0.053955	SHY
